name: AutoDev

on:
  issues:
    types: [labeled]

jobs:
  autodev:
    if: github.event.label.name == 'automagic'
    runs-on: self-hosted

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Notify Start
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          ~/Claude/dev-factory/notify.sh "üöÄ *Job Started*
          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          git checkout -b "auto/issue-${{ github.event.issue.number }}"
          git config user.name "Eetu Karppanen"
          git config user.email "eetu@kuinka.agency"

      - name: Run Claude
        id: claude
        run: |
          START_TIME=$(date +%s)
          CLAUDE_OUTPUT="/tmp/claude-output-${{ github.run_id }}.json"
          PROMPT_FILE=~/Claude/dev-factory/prompts/implement.md

          # Build prompt from template
          PROMPT=$(cat "$PROMPT_FILE" | \
            sed "s|{{REPO}}|${{ github.repository }}|g" | \
            sed "s|{{ISSUE_NUMBER}}|${{ github.event.issue.number }}|g" | \
            sed "s|{{ISSUE_TITLE}}|${{ github.event.issue.title }}|g")

          # Inject issue body (multiline safe)
          ISSUE_BODY=$(cat <<'ISSUE_BODY_EOF'
          ${{ github.event.issue.body }}
          ISSUE_BODY_EOF
          )
          PROMPT=$(echo "$PROMPT" | sed "s|{{ISSUE_BODY}}|$ISSUE_BODY|g")

          # Run Claude with JSON output
          claude -p --dangerously-skip-permissions --output-format json \
            "$PROMPT" > "$CLAUDE_OUTPUT" 2>&1 || true

          END_TIME=$(date +%s)
          DURATION_MS=$(( (END_TIME - START_TIME) * 1000 ))

          echo "output_file=$CLAUDE_OUTPUT" >> $GITHUB_OUTPUT
          echo "duration_ms=$DURATION_MS" >> $GITHUB_OUTPUT
          echo "start_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Log Usage
        id: usage
        run: |
          CLAUDE_OUTPUT="${{ steps.claude.outputs.output_file }}"
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          JOB_FILE=~/Claude/dev-factory/logs/jobs/${REPO_NAME}-${{ github.event.issue.number }}-${{ github.run_id }}.json

          # Ensure directories exist
          mkdir -p ~/Claude/dev-factory/logs/jobs

          # Copy full Claude output to jobs directory
          cp "$CLAUDE_OUTPUT" "$JOB_FILE" 2>/dev/null || echo '{}' > "$JOB_FILE"

          # Extract metrics from Claude JSON output
          TOTAL_COST=$(jq -r '.total_cost_usd // 0' "$CLAUDE_OUTPUT" 2>/dev/null || echo "0")
          INPUT_TOKENS=$(jq -r '.usage.input_tokens // 0' "$CLAUDE_OUTPUT" 2>/dev/null || echo "0")
          OUTPUT_TOKENS=$(jq -r '.usage.output_tokens // 0' "$CLAUDE_OUTPUT" 2>/dev/null || echo "0")
          RESULT=$(jq -r '.result // "No result available"' "$CLAUDE_OUTPUT" 2>/dev/null || echo "No result available")
          SESSION_ID=$(jq -r '.session_id // "unknown"' "$CLAUDE_OUTPUT" 2>/dev/null || echo "unknown")

          # Truncate result for Slack (first 500 chars)
          RESULT_SHORT=$(echo "$RESULT" | head -c 500)
          if [ ${#RESULT} -gt 500 ]; then
            RESULT_SHORT="${RESULT_SHORT}..."
          fi

          # Calculate duration in minutes
          DURATION_MS=${{ steps.claude.outputs.duration_ms }}
          DURATION_MIN=$(echo "scale=1; $DURATION_MS / 60000" | bc)

          # Append to usage.jsonl (compact single-line JSON)
          USAGE_LINE=$(jq -nc \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repo "${{ github.repository }}" \
            --argjson issue_number "${{ github.event.issue.number }}" \
            --argjson duration_ms "$DURATION_MS" \
            --argjson total_cost_usd "$TOTAL_COST" \
            --argjson input_tokens "$INPUT_TOKENS" \
            --argjson output_tokens "$OUTPUT_TOKENS" \
            --arg session_id "$SESSION_ID" \
            --arg run_id "${{ github.run_id }}" \
            '{timestamp: $timestamp, repo: $repo, issue_number: $issue_number, duration_ms: $duration_ms, total_cost_usd: $total_cost_usd, input_tokens: $input_tokens, output_tokens: $output_tokens, session_id: $session_id, run_id: $run_id}')

          echo "$USAGE_LINE" >> ~/Claude/dev-factory/logs/usage.jsonl

          # Export for later steps
          echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
          echo "duration_min=$DURATION_MIN" >> $GITHUB_OUTPUT
          echo "result_short<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT_SHORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create PR
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git checkout HEAD -- .github/ 2>/dev/null || true

          if git log origin/main..HEAD --oneline | grep -q .; then
            git push origin "auto/issue-${{ github.event.issue.number }}"
            PR_URL=$(gh pr create \
              --title "Auto: ${{ github.event.issue.title }}" \
              --body "Closes #${{ github.event.issue.number }}

              ---
              Generated by Dev Factory")
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "pr_created=true" >> $GITHUB_OUTPUT

            # Get list of changed files
            FILES_CHANGED=$(git diff --name-only origin/main..HEAD | head -20)
            FILES_COUNT=$(git diff --name-only origin/main..HEAD | wc -l | tr -d ' ')
            echo "files_changed<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES_CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT
          else
            echo "No changes were made - commenting on issue"
            gh issue comment ${{ github.event.issue.number }} \
              --body "AutoDev analyzed this issue but determined no code changes were needed. Please review the issue description or add more details."
            echo "pr_created=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Implementation Summary
        if: steps.create-pr.outputs.pr_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          RESULT: ${{ steps.usage.outputs.result }}
          FILES_CHANGED: ${{ steps.create-pr.outputs.files_changed }}
        run: |
          # Write comment to file to avoid shell escaping issues
          COMMENT_FILE="/tmp/comment-${{ github.run_id }}.md"

          {
            echo "## Implementation Summary"
            echo ""
            echo "**PR**: ${{ steps.create-pr.outputs.pr_url }}"
            echo ""
            echo "### What was done"
            echo "$RESULT"
            echo ""
            echo "### Files changed (${{ steps.create-pr.outputs.files_count }})"
            echo '```'
            echo "$FILES_CHANGED"
            echo '```'
            echo ""
            echo "---"
            echo "*Duration: ${{ steps.usage.outputs.duration_min }} min | Cost: \$${{ steps.usage.outputs.total_cost }}*"
          } > "$COMMENT_FILE"

          gh issue comment ${{ github.event.issue.number }} --body-file "$COMMENT_FILE"
          rm -f "$COMMENT_FILE"

      - name: Notify Complete
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [[ "${{ steps.create-pr.outputs.pr_created }}" == "true" ]]; then
            ~/Claude/dev-factory/notify.sh "‚úÖ *Job Complete*
          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }}
          PR: ${{ steps.create-pr.outputs.pr_url }}

          *What was done:*
          ${{ steps.usage.outputs.result_short }}

          _Duration: ${{ steps.usage.outputs.duration_min }} min | Cost: \$${{ steps.usage.outputs.total_cost }}_"
          else
            ~/Claude/dev-factory/notify.sh "‚ÑπÔ∏è *Job Complete - No Changes*
          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }}
          Claude determined no code changes were needed.

          _Duration: ${{ steps.usage.outputs.duration_min }} min | Cost: \$${{ steps.usage.outputs.total_cost }}_"
          fi

      - name: Notify Failed
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          ~/Claude/dev-factory/notify.sh "‚ùå *Job Failed*
          Repo: ${{ github.repository }}
          Issue: #${{ github.event.issue.number }} - ${{ github.event.issue.title }}
          Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/claude-output-${{ github.run_id }}.json
